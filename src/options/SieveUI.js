"use strict";var sieve_sec,sieve_container,SieveUI={loaded:!1,lastClicked:null,lastXY:[],cntr:0,sieve:{},init:function(){this.loaded=!0,this.search_f=document.getElementById("sieve_search"),this.info_container=sieve_sec.querySelector(".container_info"),this.countRules(),this.search_f.onkeydown=function(e){if(clearTimeout(this.timer),27===e.keyCode)return this.value="",SieveUI.search(),void e.preventDefault();if(13!==e.keyCode)this.timer=setTimeout(SieveUI.search,200);else{e.preventDefault(),SieveUI.search();var t=document.querySelectorAll("#sieve_container > div:not(.hidden)");1===t.length&&(t[0].classList.toggle("opened"),t[0].lastElementChild.textContent||SieveUI.genData(t[0]))}},sieve_container.onkeydown=function(e){e.stopPropagation();var t,n=e.target;if("SPAN"===n.nodeName&&(27===e.keyCode||13===e.keyCode))if(e.preventDefault(),t=n.textContent.trim(),27===e.keyCode&&""===t&&n.nextElementSibling.textContent&&[].every.call(n.parentNode.querySelectorAll('input[type="text"], textarea'),(function(e){return""===e.value.trim()})))n.parentNode.parentNode.removeChild(n.parentNode),SieveUI.countRules();else if(n.textContent){if(t=t.replace(/[\s,]+/g,"_").substr(0,50),n.parentNode.rule!==t){if(SieveUI.sieve[t])return void color_trans(n,"red");n.parentNode.rule&&SieveUI.sieve[n.parentNode.rule]&&(SieveUI.sieve[t]=SieveUI.sieve[n.parentNode.rule],delete SieveUI.sieve[n.parentNode.rule])}n.textContent=n.parentNode.rule=t,n.contentEditable=!1,n.className="",13===e.keyCode&&(n=n.parentNode.querySelector('input[type="text"]'))&&n.focus()}},sieve_container.onmousedown=SieveUI.move,sieve_container.onclick=SieveUI.click,sieve_container.oncontextmenu=SieveUI.rename_del,sieve_sec.querySelector(".action_buttons").onclick=function(e){switch(e.target.textContent){case"●":SieveUI.select("add");break;case"○":SieveUI.select("remove");break;case"◐":SieveUI.select("toggle");break;case"+":SieveUI.add();break;case"-":SieveUI.remove();break;case"Ø":SieveUI.disable();break;case"↓":ImprtHandler(_("NAV_SIEVE"),SieveUI.load);break;case"↑":SieveUI.exprt(e);break;case"⇓":SieveUI.update();break;case"≡":var t=$("sieve_tips").style;t.display="none"===t.display?"block":"none"}}},load:function(e,t){if(e||!SieveUI.loaded){try{var n,i,a,l,s,o;if(sieve_sec=$("sieve_sec"),sieve_container=$("sieve_container"),e?n=[]:e=cfg.sieve||{},t&&t.clear&&(sieve_container.textContent=""),Object.keys(e).length){for(l=document.createDocumentFragment(),s={},o=sieve_container.childElementCount;o--;)(a=sieve_container.children[o]).rule&&(s[a.rule]=a);for(i in e)s[i]&&t&&!t.overwrite?n.push(i):(a=SieveUI.genEntry(i,e[i]),s[i]?(s[i].classList.contains("opened")&&a.classList.add("opened"),sieve_container.replaceChild(a,s[i])):l.appendChild(a));l.childNodes.length&&(sieve_container.firstElementChild?sieve_container.insertBefore(l,sieve_container.firstElementChild):sieve_container.appendChild(l))}SieveUI.loaded?(SieveUI.countRules(),SieveUI.sieve=SieveUI.prepareRules()):SieveUI.sieve=e,n&&n.length&&console.log(app.name,"Ignored rules:",n)}catch(e){console.error(e)}SieveUI.loaded||SieveUI.init()}},prepareRules:function(e){var t,n,i,a,l,s,o=/\s+/g,r={},c=[],d=sieve_sec.querySelectorAll("#sieve_container > div"),v=function(e){return""!==e.value.trim()};for(t=0;t<d.length;++t){if(s=(l=d[t].firstElementChild).textContent.trim().replace(o," "),l.textContent=s,!s&&(!l.nextElementSibling.textContent||[].some.call(d[t].querySelectorAll('input[type="text"], textarea'),v)))return alert(_("SIV_ERR_EMPTYNAME")),l.contentEditable=!0,l.focus(),null;!e&&r[s]&&c.push(s.replace(/[[\]{}()*+?.\\^$|]/g,"\\$&")),r[s]=!0}if(!e&&c.length)return alert(_("SIV_ERR_DUPENAME")),SieveUI.search_f.value=c.filter((function(e,t,n){return n.indexOf(e,t+1)<0})).join("|"),SieveUI.search(),null;for(r={},t=0;t<d.length;++t)if(s=d[t].firstElementChild.textContent)if(r[s]={},l=r[s],d[t].classList.contains("disabled")&&(l.off=1),(i=d[t].querySelectorAll("input, textarea")).length)for(n=0;n<i.length;++n)switch(a=i[n].name.substr(0,i[n].name.indexOf("["))){case"useimg":i[n].checked&&(l[a]=1);break;case"note":i[n].value=i[n].value.trim();case"link":case"url":case"res":case"img":case"to":""!==i[n].value&&(l[a]=i[n].value.replace(/\r\n?/g,"\n"));break;case"link_ci":case"img_ci":case"link_dc":case"img_dc":case"link_loop":case"img_loop":s=a.split("_"),a=s[1],l[s=s[0]]&&i[n].checked&&(s=(l[a]||0)|("link"===s?1:2))&&(l[a]=s)}else SieveUI.sieve[d[t].rule]&&(l=SieveUI.sieve[d[t].rule],d[t].classList.contains("disabled")?l.off=1:delete l.off,r[s]=l,d[t].rule===s&&(d[t].rule=s));return r},countRules:function(e){var t=(sieve_sec.querySelectorAll("#sieve_container > div:not(.hidden)")||[]).length;$("sieve_count").textContent=t,t?this.info_container.style.display="none":(this.info_container.textContent=_(e||(this.search_f.value.trim()?"NOMATCH":"EMPTY")),this.info_container.style.display="block")},genData:function(e,t){++this.cntr;var n=e.lastChild,i="["+this.cntr+"]",a=t||this.sieve[e.rule]||{};buildNodes(n,[{tag:"label",nodes:[{tag:"input",attrs:{type:"checkbox",name:"useimg"}},{tag:"label",attrs:{class:"checkbox"}}," "+_("SIV_USEIMG")]}," ",{tag:"input",attrs:{type:"text",name:"link",placeholder:"link",class:"sieve_shorter_inp"}},{tag:"input",attrs:{type:"checkbox",id:"link_ci",name:"link_ci"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"input",attrs:{type:"checkbox",id:"link_dc",name:"link_dc"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"input",attrs:{type:"checkbox",id:"link_loop",name:"link_loop"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"input",attrs:{type:"text",name:"url",placeholder:"url"}},{tag:"textarea",attrs:{name:"res",placeholder:"res"}},{tag:"input",attrs:{type:"text",name:"img",placeholder:"img",class:"sieve_shorter_inp"}},{tag:"input",attrs:{type:"checkbox",id:"img_ci",name:"img_ci"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"input",attrs:{type:"checkbox",id:"img_dc",name:"img_dc"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"input",attrs:{type:"checkbox",id:"img_loop",name:"img_loop"}},{tag:"label",attrs:{class:"checkbox"}},{tag:"textarea",attrs:{name:"to",placeholder:"to"}},{tag:"textarea",attrs:{name:"note",placeholder:"note"}}]),n=n.querySelectorAll("input, textarea");for(var l,s=0;s<n.length;++s)n[s].id&&(l=n[s].id.split("_"),n[s].defaultChecked=n[s].checked=a[l[1]]&&a[l[1]]&("img"===l[0]?2:1),n[s].id+=i,n[s].nextSibling.setAttribute("for",n[s].id),n[s].nextSibling.title=_("SIV_"+l[1].toUpperCase())),n[s].name&&(a[n[s].name]&&("checkbox"===n[s].type?n[s].defaultChecked=n[s].checked=!!a[n[s].name]:n[s].defaultValue=n[s].value=a[n[s].name]||""),n[s].name+=i)},genEntry:function(e,t){var n=document.createElement("div");return t&&t.off&&n.classList.add("disabled"),n.rule=e,buildNodes(n,[{tag:"span"},{tag:"div",attrs:{"data-form":"1"}}]),e&&(n.firstChild.textContent=e),this.loaded&&this.genData(n,t),n},add:function(){sieve_container.insertBefore(this.genEntry(),sieve_container.firstElementChild);var e=sieve_container.firstElementChild,t=e.firstElementChild;t.contentEditable=!0,t.className="focus",e.className="opened",t.focus(),this.countRules()},select:function(e,t,n){var i;for(t=t||0,n=n||sieve_container.childElementCount;t<n;++t)(i=sieve_container.children[t].classList).contains("hidden")||i[e]("selected")},click:function(e){var t,n;if((e.stopPropagation(),"SPAN"===e.target.nodeName)&&0===e.button)if(e.shiftKey&&null!==SieveUI.lastClicked){for(t=e.target.parentNode,n=0;t=t.previousElementSibling;)n++;SieveUI.select(sieve_container.children[SieveUI.lastClicked].classList.contains("selected")?"add":"remove",Math.min(SieveUI.lastClicked,n),Math.max(SieveUI.lastClicked,n)+1)}else if(e.ctrlKey||e.metaKey){for(SieveUI.lastClicked=0,t=e.target.parentNode;t=t.previousElementSibling;)SieveUI.lastClicked++;e.target.parentNode.classList.toggle("selected"),e.preventDefault()}else!e.target.isContentEditable&&Math.abs(SieveUI.lastXY[0]-e.clientX)<4&&Math.abs(SieveUI.lastXY[1]-e.clientY)<4&&(e.target.parentNode.classList.toggle("opened"),e.target.nextElementSibling.textContent||SieveUI.genData(e.target.parentNode))},move:function(e){e.stopPropagation(),SieveUI.lastXY=[e.clientX,e.clientY];var t,n,i=e.target.parentNode;e.target.isContentEditable||"SPAN"!==e.target.nodeName||i.classList.contains("opened")||0!==e.button||(e.preventDefault(),document.onmousemove=function(e){if(!(Math.abs(SieveUI.lastXY[0]-e.clientX)<4&&Math.abs(SieveUI.lastXY[1]-e.clientY)<4||(i.style.cssText="left:"+(e.clientX+15)+"px;top:"+(e.clientY+15)+"px",i.classList.contains("move"))))for(i.classList.add("move"),n=sieve_container.querySelectorAll((i.classList.contains("selected")?".selected, ":"")+".move"),t=0;t<n.length;++t)i!==n[t]&&n[t].classList.add("move_multi")},document.onmouseup=function(e){if(i.classList.contains("move")&&e.target.parentNode.rule){var a=document.createDocumentFragment();for(t=0;t<n.length;++t)sieve_container.removeChild(n[t]),a.appendChild(n[t]);sieve_container.insertBefore(a,e.target.parentNode)}for(i.classList.remove("move"),n=sieve_container.querySelectorAll(".move_multi"),t=0;t<n.length;++t)n[t].classList.remove("move_multi");sieve_container.onmouseover=document.onmouseup=document.onmousemove=null})},exprt:function(e){if(sieve_container.childElementCount){var t,n=sieve_container.querySelectorAll("div.selected"),i=SieveUI.prepareRules(!0),a={};if(i){if(n.length)for(t=0;t<n.length;++t)a[n[t].rule]=i[n[t].rule];else a=i;"{}"!==(a=JSON.stringify(a,null,e.shiftKey?2:0))&&download(a,app.name+"-sieve.json",e.ctrlKey)}}},disable:function(){for(var e=sieve_container.childElementCount,t=sieve_container.querySelectorAll("div.selected").length,n=sieve_container.children;e--;)t&&!n[e].classList.contains("selected")||n[e].classList.toggle("disabled")},remove:function(){if(confirm(_("DELITEMS"))){var e=0,t=sieve_container.querySelectorAll("div.selected");if(t.length)for(;e<t.length;++e)sieve_container.removeChild(t[e]);else sieve_container.textContent="";this.countRules()}},rename_del:function(e){e.stopPropagation(),"SPAN"===e.target.nodeName&&(e.shiftKey?(e.preventDefault(),(e=e.target).textContent=e.textContent.trim(),e.contentEditable=!e.isContentEditable,e.className=e.isContentEditable?"focus":"",e.contentEditable&&e.focus()):e.ctrlKey&&(e.preventDefault(),confirm(_("AREYOUSURE"))&&((e=e.target.parentNode).parentNode.removeChild(e),SieveUI.countRules())))},search:function(){for(var e=RegExp(SieveUI.search_f.value.trim()||".","i"),t=sieve_container.children,n=t.length;n--;)t[n].firstElementChild.textContent&&t[n].classList[e.test(t[n].firstElementChild.textContent)?"remove":"add"]("hidden");SieveUI.countRules()},update:function(){cfg.sieve&&Object.keys(cfg.sieve).length&&!confirm(_("SIV_UPDALERT"))||(Port.listen((function(e){Port.listen(null),SieveUI.load((e.data||e).updated_sieve)})),Port.send({cmd:"update_sieve"}),sieve_container.textContent="",SieveUI.countRules("LOADING"))}};